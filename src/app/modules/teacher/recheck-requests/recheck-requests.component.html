<div class="recheck-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title">Recheck Requests</h1>
      <p class="page-subtitle">Manage student re-evaluation requests</p>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="submitSuccess" class="success-message">
    <mat-icon>check_circle</mat-icon>
    <div>
      <strong>Success!</strong>
      <p>{{ submitSuccess }}</p>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="submitError" class="error-message">
    <mat-icon>error</mat-icon>
    <div>
      <strong>Error!</strong>
      <p>{{ submitError }}</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon pending">
        <mat-icon>pending_actions</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ pendingRequests }}</h3>
        <p>Pending Requests</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon rejected">
        <mat-icon>cancel</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ rejectedRequests }}</h3>
        <p>Rejected</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon approved">
        <mat-icon>thumb_up</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ approvedRequests }}</h3>
        <p>Approved</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon total">
        <mat-icon>folder_open</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ totalRequests }}</h3>
        <p>Total Requests</p>
      </div>
    </div>
  </div>

  <!-- Main Table Card -->
  <mat-card class="table-card">
    <!-- Table Header -->
    <div class="table-header">
      <div class="table-header-left">
        <h2>All Recheck Requests</h2>
        <div class="approval-note">
          Note: Teachers can update marks only after admin approves the recheck request.
        </div>
      </div>
      <div class="filter-controls">
        <mat-form-field appearance="outline" class="page-size-selector">
          <mat-label>Show</mat-label>
          <mat-select [(value)]="pageSize" (selectionChange)="onPageSizeChange()">
            <mat-option [value]="5">5 requests</mat-option>
            <mat-option [value]="10">10 requests</mat-option>
            <mat-option [value]="20">20 requests</mat-option>
            <mat-option [value]="50">50 requests</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Dropdown UI (same style as Update Marks) -->
        <mat-form-field appearance="outline" class="status-filter-field">
          <mat-label>Status</mat-label>
          <mat-select
            [value]="''"
            (selectionChange)="dataSource.filter = ($event.value || '').trim().toLowerCase(); paginator.firstPage()"
          >
            <mat-option [value]="''">All Status</mat-option>
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="approved">Approved</mat-option>
            <mat-option value="rejected">Rejected</mat-option>
            <mat-option value="completed">Completed</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Table Container -->
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z1" multiTemplateDataRows>

        <!-- Expand Column (dropdown) -->
        <ng-container matColumnDef="expand">
          <th mat-header-cell *matHeaderCellDef class="expand-header"></th>
          <td mat-cell *matCellDef="let r" class="expand-cell">
            <button
              mat-icon-button
              color="primary"
              (click)="toggleRow(r); $event.stopPropagation()"
              [attr.aria-label]="expandedRow === r.recheckId ? 'Collapse row' : 'Expand row'"
            >
              <mat-icon>{{ expandedRow === r.recheckId ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>
            </button>
          </td>
        </ng-container>
        
        <!-- Student Name Column -->
        <ng-container matColumnDef="studentName">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>person</mat-icon>
              Student Name
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <div class="student-cell">
              <div class="student-name">{{ r.studentName }}</div>
              <div class="student-roll">{{ r.rollNo }} | {{ r.className }}</div>
            </div>
          </td>
        </ng-container>
        
        <!-- Subject Column -->
        <ng-container matColumnDef="subject">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>subject</mat-icon>
              Subject
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <mat-chip class="subject-chip" [ngClass]="getSubjectClass(r.subject)">
              <mat-icon class="chip-icon">book</mat-icon>
              {{ r.subject }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Marks Column -->
        <ng-container matColumnDef="marksObtained">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>grade</mat-icon>
              Marks
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <div class="marks-cell">
              <!-- View Mode -->
              <div *ngIf="editingMarkId !== r.marksId" class="marks-view">
                <span class="mark-value">{{ r.marksObtained }}/{{ r.maxMarks || 100 }}</span>
              </div>
              <!-- Edit Mode -->
              <div *ngIf="editingMarkId === r.marksId" class="marks-edit">
                <mat-form-field appearance="outline" class="marks-input">
                  <mat-label>Marks</mat-label>
                  <input 
                    matInput 
                    type="number"
                    [(ngModel)]="editedMarks[r.marksId]"
                    min="0"
                    max="100"
                    [name]="'marks_' + r.marksId"
                  >
                  <mat-icon matPrefix>grade</mat-icon>
                  <span matSuffix>/100</span>
                </mat-form-field>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>pending</mat-icon>
              Status
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <mat-chip class="status-chip" [ngClass]="getStatusClass(r.status)">
              <mat-icon>{{ getStatusIcon(r.status) }}</mat-icon>
              {{ getStatusText(r.status) }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Action Column -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>settings</mat-icon>
              Actions
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <div class="action-buttons">
              <!-- View Mode -->
              <div *ngIf="editingMarkId !== r.marksId" class="view-actions">
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="editMark(r)"
                  matTooltip="Edit Mark"
                  *ngIf="(r.status || '').toLowerCase() === 'approved'"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="approveRequest(r)"
                  matTooltip="Approve"
                  *ngIf="r.status === 'pending'"
                >
                  <mat-icon>thumb_up</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="warn"
                  (click)="rejectRequest(r)"
                  matTooltip="Reject"
                  *ngIf="r.status === 'pending'"
                >
                  <mat-icon>cancel</mat-icon>
                </button>
              </div>
              <!-- Edit Mode -->
              <div *ngIf="editingMarkId === r.marksId" class="edit-actions">
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="saveMark(r)"
                  matTooltip="Save changes"
                  [disabled]="isSubmitting"
                >
                  <mat-icon>{{ isSubmitting ? 'hourglass_empty' : 'save' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="cancelEdit()"
                  matTooltip="Cancel edit"
                  [disabled]="isSubmitting"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Expanded Detail Row -->
        <ng-container matColumnDef="expandedDetail">
          <td
            mat-cell
            *matCellDef="let r"
            class="detail-cell"
            [attr.colspan]="displayedColumnsWithExpand.length"
          >
            <div class="expanded-detail" [class.expanded]="expandedRow === r.recheckId">
              <div class="detail-grid">
                <div class="detail-item"><strong>Reason:</strong> {{ r.reason || '-' }}</div>
                <div class="detail-item"><strong>Admin Note:</strong> {{ r.adminNotes || '-' }}</div>
                <div class="detail-item"><strong>Issue Date:</strong> {{ r.requestDate ? (r.requestDate | date:'medium') : '-' }}</div>
                <div class="detail-item"><strong>Resolve Date:</strong> {{ r.resolvedDate ? (r.resolvedDate | date:'medium') : '-' }}</div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Header Row -->
        <tr mat-header-row *matHeaderRowDef="displayedColumnsWithExpand"></tr>
        
        <!-- Data Rows -->
        <tr mat-row *matRowDef="let row; columns: displayedColumnsWithExpand;" class="data-row"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail'];" class="detail-row"></tr>

      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!dataSource || dataSource.data.length === 0" class="empty-state">
      <mat-icon class="empty-icon">inbox</mat-icon>
      <h3>No Recheck Requests</h3>
      <p>All requests have been processed</p>
    </div>

    <!-- Paginator -->
    <mat-paginator 
      *ngIf="dataSource && dataSource.data.length > 0"
      [pageSizeOptions]="[5, 10, 20, 50]" 
      [pageSize]="pageSize"
      showFirstLastButtons
      class="custom-paginator">
    </mat-paginator>

  </mat-card>
</div>