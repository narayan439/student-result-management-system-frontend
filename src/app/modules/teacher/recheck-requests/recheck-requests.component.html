<div class="recheck-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title">Recheck Requests</h1>
      <p class="page-subtitle">Manage student re-evaluation requests</p>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="submitSuccess" class="success-message">
    <mat-icon>check_circle</mat-icon>
    <div>
      <strong>Success!</strong>
      <p>{{ submitSuccess }}</p>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="submitError" class="error-message">
    <mat-icon>error</mat-icon>
    <div>
      <strong>Error!</strong>
      <p>{{ submitError }}</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon pending">
        <mat-icon>pending_actions</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ pendingRequests }}</h3>
        <p>Pending Requests</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon approved">
        <mat-icon>thumb_up</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ inReviewRequests }}</h3>
        <p>In Review</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon resolved">
        <mat-icon>task_alt</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ resolvedRequests }}</h3>
        <p>Resolved Requests</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon total">
        <mat-icon>folder_open</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ totalRequests }}</h3>
        <p>Total Requests</p>
      </div>
    </div>
  </div>

  <!-- Main Table Card -->
  <mat-card class="table-card">
    <!-- Table Header -->
    <div class="table-header">
      <h2>All Recheck Requests</h2>
      <div class="filter-controls">
        <mat-form-field appearance="outline" class="page-size-selector">
          <mat-label>Show</mat-label>
          <mat-select [(value)]="pageSize" (selectionChange)="onPageSizeChange()">
            <mat-option [value]="5">5 requests</mat-option>
            <mat-option [value]="10">10 requests</mat-option>
            <mat-option [value]="20">20 requests</mat-option>
            <mat-option [value]="50">50 requests</mat-option>
          </mat-select>
        </mat-form-field>
        
        <button mat-stroked-button class="filter-btn">
          <mat-icon>filter_list</mat-icon> Filter Requests
        </button>
      </div>
    </div>

    <!-- Table Container -->
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z1">
        
        <!-- Student Name Column -->
        <ng-container matColumnDef="studentName">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>person</mat-icon>
              Student Name
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <div class="student-cell">
              <div class="student-name">{{ r.studentName }}</div>
              <div class="student-roll">{{ r.rollNo }} | {{ r.className }}</div>
            </div>
          </td>
        </ng-container>
        
        <!-- Subject Column -->
        <ng-container matColumnDef="subject">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>subject</mat-icon>
              Subject
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <mat-chip class="subject-chip" [ngClass]="getSubjectClass(r.subject)">
              <mat-icon class="chip-icon">book</mat-icon>
              {{ r.subject }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Reason Column -->
        <ng-container matColumnDef="reason">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>description</mat-icon>
              Reason
            </div>
          </th>
          <td mat-cell *matCellDef="let r" class="reason-cell">
            <div class="reason-content">
              <mat-icon class="reason-icon">message</mat-icon>
              <div class="reason-text">{{ r.reason }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Marks Column -->
        <ng-container matColumnDef="marksObtained">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>grade</mat-icon>
              Marks
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <div class="marks-cell">
              <!-- View Mode -->
              <div *ngIf="editingMarkId !== r.marksId" class="marks-view">
                <span class="mark-value">{{ r.marksObtained }}/{{ r.maxMarks || 100 }}</span>
              </div>
              <!-- Edit Mode -->
              <div *ngIf="editingMarkId === r.marksId" class="marks-edit">
                <mat-form-field appearance="outline" class="marks-input">
                  <mat-label>Marks</mat-label>
                  <input 
                    matInput 
                    type="number"
                    [(ngModel)]="editedMarks[r.marksId]"
                    min="0"
                    max="100"
                    [name]="'marks_' + r.marksId"
                  >
                  <mat-icon matPrefix>grade</mat-icon>
                  <span matSuffix>/100</span>
                </mat-form-field>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>pending</mat-icon>
              Status
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <mat-chip class="status-chip" [ngClass]="getStatusClass(r.status)">
              <mat-icon>{{ getStatusIcon(r.status) }}</mat-icon>
              {{ getStatusText(r.status) }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Action Column -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>
            <div class="column-header">
              <mat-icon>settings</mat-icon>
              Actions
            </div>
          </th>
          <td mat-cell *matCellDef="let r">
            <div class="action-buttons">
              <!-- View Mode -->
              <div *ngIf="editingMarkId !== r.marksId" class="view-actions">
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="editMark(r)"
                  matTooltip="Edit Mark"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="approveRequest(r)"
                  matTooltip="Approve"
                  *ngIf="r.status === 'pending'"
                >
                  <mat-icon>thumb_up</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="warn"
                  (click)="rejectRequest(r)"
                  matTooltip="Reject"
                  *ngIf="r.status === 'pending'"
                >
                  <mat-icon>cancel</mat-icon>
                </button>
              </div>
              <!-- Edit Mode -->
              <div *ngIf="editingMarkId === r.marksId" class="edit-actions">
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="saveMark(r)"
                  matTooltip="Save changes"
                  [disabled]="isSubmitting"
                >
                  <mat-icon>{{ isSubmitting ? 'hourglass_empty' : 'save' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="cancelEdit()"
                  matTooltip="Cancel edit"
                  [disabled]="isSubmitting"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Header Row -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        
        <!-- Data Rows -->
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!dataSource || dataSource.data.length === 0" class="empty-state">
      <mat-icon class="empty-icon">inbox</mat-icon>
      <h3>No Recheck Requests</h3>
      <p>All requests have been processed</p>
    </div>

    <!-- Paginator -->
    <mat-paginator 
      *ngIf="dataSource && dataSource.data.length > 0"
      [pageSizeOptions]="[5, 10, 20, 50]" 
      [pageSize]="pageSize"
      showFirstLastButtons
      class="custom-paginator">
    </mat-paginator>

  </mat-card>
</div>